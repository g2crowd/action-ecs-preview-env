# Preview Environment on ECS GitHub Action

This is a GitHub action to provision preview environment on AWS ECS.

[![GitHub Super-Linter](https://github.com/g2crowd/action-ecs-preview-env/workflows/Lint%20Code%20Base/badge.svg)](https://github.com/marketplace/actions/super-linter)

## Table of Contents

<!-- toc -->

* [Usage](#usage)
* [Inputs](#inputs)
  * [Deploy](#deploy)
  * [Uneploy](#undeploy)
* [Configurations](#configurations)
  * [Task Definition](#task-definition)
  * [ECS Task](#ecs-task)
  * [Database](#database)
  * [Environment Variables](#environment-variables)
* [Permissions](#permissions)

<!-- tocstop -->

## Usage
### Deploy
```yaml
    - name: Deploy preview environment
      uses: g2crowd/action-ecs-preview-env@main
      with:
        command: deploy
        org: my-org
        repo: my-repo
        branch: my-branch
        pr: 100
        author: saurabh
        image: my-image
        sha: db3fa68a6abca7ded16e984aa3cd8f1bd2adc792
        tfstate: tf-state/prenv/terraform.tfstate
```

### Undeploy
```yaml
    - name: Undeploy preview environment
      uses: g2crowd/action-ecs-preview-env@main
      with:
        command: undeploy
        org: my-org
        repo: my-repo
        pr: 100
        sha: db3fa68a6abca7ded16e984aa3cd8f1bd2adc792
```

## Inputs
### Deploy

* COMMAND (**Required**): **deploy**
* ORG (**Required**): GitHub organisation name
* REPO (**Required**): Repository name
* BRANCH (**Required**): Branch name
* PR (**Required**): Pull request number
* AUTHOR (**Required**): Name of the commit author
* IMAGE (**Required**): Name of image to be deployed
* SHA (**Required**): Latest commit sha in pull request
* ASSUME : IAM role to be assumed for creating DNS recordset
* TFSTATE: Terraform state file S3 path

### Undeploy

* COMMAND (**Required**): **undeploy**
* ORG (**Required**): GitHub organisation name
* REPO (**Required**): Repository name
* PR (**Required**): Pull request number
* SHA (**Required**): Latest commit sha in pull request
* ASSUME : IAM role to be assumed for creating DNS recordset

### Environment Variables

* GITHUB_TOKEN (**Required**): GitHub authentication token
* AWS_ACCESS_KEY_ID (**Required**): An AWS access key associated with an IAM user
* AWS_SECRET_ACCESS_KEY (**Required**): The secret key associated with the access key
* AWS_SECRET_ACCESS_KEY (**Required**): The secret key associated with the access key
* AWS_DEFAULT_REGION (**Required**): The AWS Region to send the request to


## Configurations

**NOTE:** The default location for configuration files is `.prenv` folder at root of the repo. The sample configuration files are available at _.prenv_ folder.

### Task Definition
An [Amazon ECS task definitions](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html) is required to run Docker containers in Amazon ECS. Create a valid `.prenv/task_definition.json` task definition configuration file. The environment variables prefixed with **PRENV_** can be used as a placeholders to add dynamic values into task definition.

### ECS Task
The ECS configuration to starts a new task using the given task definition configuration.
* Cluster (**Required**): The short name of the cluster to run your task on
* Subnet Ids (**Required**): The IDs of the subnets associated with the task
* Security Groups (**Required**): The IDs of the security groups associated with the task
* Platform (**Required**): The ECS platform version the task uses
* DNS: Route53 config to create DNS recordset
  * Hosted Zone (**Required**): The ID of the hosted zone that contains the resource record sets
  * Domain (**Required**): The name of the DNS record

### Database
The database configuration used in preview environment. This is optional configuration.
* Databases: List of databases available
  * DB Label (**Required**): Label name used to select this database
    * Key:Value (**Required**): Key value pair defining DB config, this will be exposed as environment var
    * Share: Whether to share database with multiple preview environments (Default: true)

### Environment Variables
The environment variables prefixed with **PRENV_** can be placed in the task definition configuration file. Following are the environment variable generated by the action:
* PRENV_ORG: GitHub organisation name
* PRENV_REPO: Repository name
* PRENV_BRANCH: Branch name
* PRENV_PR: Pull request number
* PRENV_AUTHOR: Name of the commit author
* PRENV_IMAGE: Name of image to be deployed
* PRENV_SHA: Latest commit sha in pull request
* PRENV_TASK_FAMILY: Task definition family name
* PRENV_DNS_NAME: DNS recordset name
* PRENV_STACK_NAME: Name of the stack deployed
* PRENV_DB_<KEY>: Keys defined in database config

## Permissions

This action requires the following minimum set of permissions:

```json
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Sid":"ECSDeployAccess",
      "Effect":"Allow",
      "Action":[
        "ecs:DescribeTasks",
        "ecs:ListTasks",
        "ecs:RunTask",
        "ecs:StartTask",
        "ecs:StopTask"
      ],
      "Resource":"*",
      "Condition":{
        "ArnEquals":{
          "ecs:cluster":"arn:aws:ecs:<region>:<aws_account_id>:cluster/<cluster_name>"
        }
      }
    },
    {
      "Sid":"ECSTaskDefinationAccess",
      "Effect":"Allow",
      "Action":[
        "ecs:DeregisterTaskDefinition",
        "ecs:RegisterTaskDefinition",
        "ecs:DescribeTaskDefinition"
      ],
      "Resource":"*"
    },
    {
      "Sid":"IAMPassRole",
      "Effect":"Allow",
      "Action":[
        "iam:PassRole"
      ],
      "Resource":[
        "arn:aws:iam::<aws_account_id>:role/<task_definition_task_role_name>",
        "arn:aws:iam::<aws_account_id>:role/<task_definition_task_execution_role_name>"
      ]
    },
    {
      "Sid":"DNSEntryAccess",
      "Effect":"Allow",
      "Action":[
        "route53:ChangeResourceRecordSets",
        "route53:ListResourceRecordSets"
      ],
      "Resource":[
        "arn:aws:route53:::hostedzone/<hostedzone>"
      ]
    }
  ]
}
```
